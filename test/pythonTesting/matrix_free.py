import taichi as ti
from src.utils.MatrixSolver.MatrixFreeCG import MatrixFreeCG 
from src.utils.MatrixSolver.LinearOperator import LinearOperator

ti.init(arch=ti.cpu, default_fp=ti.f64)

operator = MatrixFreeCG(64)
n = 64
x = ti.field(dtype=float, shape=(n,))
b = ti.field(dtype=float, shape=(n,))

@ti.kernel
def init():
    for i in ti.grouped(b):
        x[i] = 0.0
    b[0] = -8.638032737750933e-18
    b[1] = -24500.001200499995
    b[2] = 5.456568843316214e-18
    b[3] = -24500.001200499995
    b[4] = 8.638032737750936e-18
    b[5] = -24499.998799500016
    b[6] = -5.456568843316214e-18
    b[7] = -24499.998799500016

@ti.kernel
def compute(v: ti.template(), mv: ti.template()):
    mv[0] = 250010829558.35184*v[0]+4807692.543269229*v[1]+-6971154.505769242*v[2]+961538.508653846*v[3]+2644230.7692307527*v[4]+-961538.6971153832*v[5]+-6490384.615384598*v[6]+-4807692.354807692*v[7]
    mv[1] = 4807692.543269229*v[0]+250010829557.88068*v[1]+-961538.5086538461*v[2]+2644230.580769228*v[3]+961538.2259615406*v[4]+-6971153.846153852*v[5]+-4807692.260576923*v[6]+-6490384.61538461*v[7]
    mv[2] = -6971154.505769242*v[0]+-961538.5086538461*v[1]+250010829558.35184*v[2]+-4807692.54326923*v[3]+-6490384.615384598*v[4]+4807692.354807693*v[5]+2644230.769230753*v[6]+961538.697115383*v[7]
    mv[3] = 961538.508653846*v[0]+2644230.580769228*v[1]+-4807692.54326923*v[2]+250010829557.88068*v[3]+4807692.260576923*v[4]+-6490384.61538461*v[5]+-961538.2259615406*v[6]+-6971153.846153852*v[7]
    mv[4] = 2644230.7692307527*v[0]+961538.2259615406*v[1]+-6490384.615384598*v[2]+4807692.260576923*v[3]+250010805057.0328*v[4]+-4807692.072115387*v[5]+-6971153.186538482*v[6]+-961538.4144230776*v[7]
    mv[5] = -961538.6971153832*v[0]+-6971153.846153852*v[1]+4807692.354807693*v[2]+-6490384.61538461*v[3]+-4807692.072115387*v[4]+250010805057.50397*v[5]+961538.4144230776*v[6]+2644230.957692301*v[7]
    mv[6] = -6490384.615384598*v[0]+-4807692.260576923*v[1]+2644230.769230753*v[2]+-961538.2259615406*v[3]+-6971153.186538482*v[4]+961538.4144230776*v[5]+250010805057.0328*v[6]+4807692.072115387*v[7]
    mv[7] = -4807692.354807692*v[0]+-6490384.61538461*v[1]+961538.697115383*v[2]+-6971153.846153852*v[3]+-961538.4144230776*v[4]+2644230.957692301*v[5]+4807692.072115387*v[6]+250010805057.50397*v[7]

init()        
A = LinearOperator(compute)
print(b)
print(operator.solve(A, b, x, 8, maxiter=10*8, tol=1e-18))
print(x)